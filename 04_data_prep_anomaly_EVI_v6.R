library(raster)
library(methods)
library(zoo)
library(xts)
library(rgdal)
library(rgeos)
library(maptools)


vipath <- "~/PROJECTS/16b_trapananda_TS/02_MOD13Q1_v6_mask"
vifl <- list.files(path=vipath, pattern=glob2rx("*.tif"), full.names=T)
sceneID <- substr(vifl, 62, 97)
evi.out.path <- "~/PROJECTS/16b_trapananda_TS/03_MOD13Q1_EVI_clean"
evi.out.name <- paste(evi.out.path,'/','clean_EVI_', sceneID,'.tif',sep='')


# QA2 thresholds, please cross-check with output table 2

#QA2.thres1 = 2193 # Enter QA2 threshold <
#QA2.thres2 = 2031 # Enter QA2 threshold >
# this ones to be deleted in the loop, do it manually -> QA2 == 2062,2066,2070,2118,2122,2126,2186,2190

#----------------------------------------------------------------------------------------

# Copiar y pegar los valores obtenidos del script "preparing_QA_values"

for (i in 1:length(vifl)){
  r2 <- raster(vifl[i], band=2) # band=1 for NDVI, 2 for EVI
  QA2 <- raster(vifl[i], band=3)
  r2[QA2==2058] <- NA 
  r2[QA2==2062] <- NA 
  r2[QA2==2063] <- NA 
  r2[QA2==2066] <- NA 
  r2[QA2==2067] <- NA 
  r2[QA2==2109] <- NA 
  r2[QA2==2110] <- NA 
  r2[QA2==2111] <- NA 
  r2[QA2==2114] <- NA 
  r2[QA2==2118] <- NA 
  r2[QA2==2122] <- NA 
  r2[QA2==2174] <- NA 
  r2[QA2==2182] <- NA 
  r2[QA2==2186] <- NA 
  r2[QA2==2190] <- NA 
  r2[QA2==2237] <- NA 
  r2[QA2==2253] <- NA 
  r2[QA2==2254] <- NA 
  r2[QA2==2257] <- NA 
  r2[QA2==2258] <- NA 
  r2[QA2==2261] <- NA 
  r2[QA2==2262] <- NA 
  r2[QA2==2301] <- NA 
  r2[QA2==2302] <- NA 
  r2[QA2==2317] <- NA 
  r2[QA2==2318] <- NA 
  r2[QA2==2321] <- NA 
  r2[QA2==2322] <- NA 
  r2[QA2==2323] <- NA 
  r2[QA2==2325] <- NA 
  r2[QA2==2326] <- NA 
  r2[QA2==2327] <- NA 
  r2[QA2==2365] <- NA 
  r2[QA2==2366] <- NA 
  r2[QA2==2374] <- NA 
  r2[QA2==2378] <- NA 
  r2[QA2==2382] <- NA 
  r2[QA2==2430] <- NA 
  r2[QA2==2441] <- NA 
  r2[QA2==2442] <- NA 
  r2[QA2==2445] <- NA 
  r2[QA2==2446] <- NA 
  r2[QA2==2449] <- NA 
  r2[QA2==2450] <- NA 
  r2[QA2==2493] <- NA 
  r2[QA2==2494] <- NA 
  r2[QA2==2513] <- NA 
  r2[QA2==2514] <- NA 
  r2[QA2==2517] <- NA 
  r2[QA2==2518] <- NA 
  r2[QA2==2521] <- NA 
  r2[QA2==2522] <- NA 
  r2[QA2==2557] <- NA 
  r2[QA2==2558] <- NA 
  r2[QA2==3094] <- NA 
  r2[QA2==3098] <- NA 
  r2[QA2==3099] <- NA 
  r2[QA2==3102] <- NA 
  r2[QA2==3103] <- NA 
  r2[QA2==3134] <- NA 
  r2[QA2==3135] <- NA 
  r2[QA2==3150] <- NA 
  r2[QA2==3154] <- NA 
  r2[QA2==3158] <- NA 
  r2[QA2==3198] <- NA 
  r2[QA2==3218] <- NA 
  r2[QA2==3222] <- NA 
  r2[QA2==3226] <- NA 
  r2[QA2==3262] <- NA 
  r2[QA2==3290] <- NA 
  r2[QA2==3294] <- NA 
  r2[QA2==3298] <- NA 
  r2[QA2==3326] <- NA 
  r2[QA2==3354] <- NA 
  r2[QA2==3358] <- NA 
  r2[QA2==3362] <- NA 
  r2[QA2==3363] <- NA 
  r2[QA2==3390] <- NA 
  r2[QA2==3410] <- NA 
  r2[QA2==3414] <- NA 
  r2[QA2==3418] <- NA 
  r2[QA2==3454] <- NA 
  r2[QA2==3478] <- NA 
  r2[QA2==3482] <- NA 
  r2[QA2==3486] <- NA 
  r2[QA2==3518] <- NA 
  r2[QA2==3550] <- NA 
  r2[QA2==3554] <- NA 
  r2[QA2==3558] <- NA 
  r2[QA2==3582] <- NA 
  r2[QA2==4105] <- NA 
  r2[QA2==4106] <- NA 
  r2[QA2==4109] <- NA 
  r2[QA2==4110] <- NA 
  r2[QA2==4113] <- NA 
  r2[QA2==4114] <- NA 
  r2[QA2==4115] <- NA 
  r2[QA2==4157] <- NA 
  r2[QA2==4158] <- NA 
  r2[QA2==4159] <- NA 
  r2[QA2==4166] <- NA 
  r2[QA2==4170] <- NA 
  r2[QA2==4229] <- NA 
  r2[QA2==4233] <- NA 
  r2[QA2==4234] <- NA 
  r2[QA2==4237] <- NA 
  r2[QA2==4238] <- NA 
  r2[QA2==4285] <- NA 
  r2[QA2==4301] <- NA 
  r2[QA2==4305] <- NA 
  r2[QA2==4309] <- NA 
  r2[QA2==4349] <- NA 
  r2[QA2==4365] <- NA 
  r2[QA2==4366] <- NA 
  r2[QA2==4369] <- NA 
  r2[QA2==4370] <- NA 
  r2[QA2==4373] <- NA 
  r2[QA2==4374] <- NA 
  r2[QA2==4413] <- NA 
  r2[QA2==4414] <- NA 
  r2[QA2==5142] <- NA 
  r2[QA2==5146] <- NA 
  r2[QA2==5150] <- NA 
  r2[QA2==5182] <- NA 
  r2[QA2==5198] <- NA 
  r2[QA2==5202] <- NA 
  r2[QA2==5206] <- NA 
  r2[QA2==5266] <- NA 
  r2[QA2==5270] <- NA 
  r2[QA2==5274] <- NA 
  r2[QA2==5310] <- NA 
  r2[QA2==5342] <- NA 
  r2[QA2==5346] <- NA 
  r2[QA2==5402] <- NA 
  r2[QA2==5406] <- NA 
  r2[QA2==5410] <- NA 
  r2[QA2==5438] <- NA 
  r2[QA2==6154] <- NA 
  r2[QA2==6157] <- NA 
  r2[QA2==6158] <- NA 
  r2[QA2==6161] <- NA 
  r2[QA2==6162] <- NA 
  r2[QA2==6205] <- NA 
  r2[QA2==6206] <- NA 
  r2[QA2==6277] <- NA 
  r2[QA2==6281] <- NA 
  r2[QA2==6285] <- NA 
  r2[QA2==6413] <- NA 
  r2[QA2==6417] <- NA 
  r2[QA2==6418] <- NA 
  r2[QA2==6421] <- NA 
  r2[QA2==6422] <- NA 
  r2[QA2==6461] <- NA 
  r2[QA2==7190] <- NA 
  r2[QA2==7194] <- NA 
  r2[QA2==7198] <- NA 
  r2[QA2==7230] <- NA 
  r2[QA2==7250] <- NA 
  r2[QA2==7450] <- NA 
  r2[QA2==7454] <- NA 
  r2[QA2==7458] <- NA 
  r2[QA2==18445] <- NA 
  r2[QA2==18446] <- NA 
  r2[QA2==18449] <- NA 
  r2[QA2==18450] <- NA 
  r2[QA2==18451] <- NA 
  r2[QA2==18453] <- NA 
  r2[QA2==18454] <- NA 
  r2[QA2==18455] <- NA 
  r2[QA2==18493] <- NA 
  r2[QA2==18494] <- NA 
  r2[QA2==18495] <- NA 
  r2[QA2==18577] <- NA 
  r2[QA2==18641] <- NA 
  r2[QA2==18645] <- NA 
  r2[QA2==18649] <- NA 
  r2[QA2==18705] <- NA 
  r2[QA2==18709] <- NA 
  r2[QA2==18710] <- NA 
  r2[QA2==18713] <- NA 
  r2[QA2==18714] <- NA 
  r2[QA2==18715] <- NA 
  r2[QA2==18749] <- NA 
  r2[QA2==18750] <- NA 
  r2[QA2==18837] <- NA 
  r2[QA2==18901] <- NA 
  r2[QA2==18905] <- NA 
  r2[QA2==18909] <- NA 
  r2[QA2==19482] <- NA 
  r2[QA2==19486] <- NA 
  r2[QA2==19490] <- NA 
  r2[QA2==19742] <- NA 
  r2[QA2==19746] <- NA 
  r2[QA2==19750] <- NA 
  r2[QA2==20493] <- NA 
  r2[QA2==20494] <- NA 
  r2[QA2==20497] <- NA 
  r2[QA2==20498] <- NA 
  r2[QA2==20499] <- NA 
  r2[QA2==20501] <- NA 
  r2[QA2==20502] <- NA 
  r2[QA2==20541] <- NA 
  r2[QA2==20542] <- NA 
  r2[QA2==20753] <- NA 
  r2[QA2==20757] <- NA 
  r2[QA2==20758] <- NA 
  r2[QA2==20761] <- NA 
  r2[QA2==20762] <- NA 
  r2[QA2==20797] <- NA 
  r2[QA2==20798] <- NA 
  r2[QA2==21530] <- NA 
  r2[QA2==21534] <- NA 
  r2[QA2==21538] <- NA 
  r2[QA2==21790] <- NA 
  r2[QA2==21794] <- NA 
  r2[QA2==21798] <- NA 
  r2[QA2==22541] <- NA 
  r2[QA2==22542] <- NA 
  r2[QA2==22545] <- NA 
  r2[QA2==22546] <- NA 
  r2[QA2==22550] <- NA 
  r2[QA2==22590] <- NA 
  r2[QA2==22805] <- NA 
  r2[QA2==22806] <- NA 
  r2[QA2==23582] <- NA 
  r2[QA2==34833] <- NA 
  r2[QA2==34834] <- NA 
  r2[QA2==34837] <- NA 
  r2[QA2==34838] <- NA 
  r2[QA2==34839] <- NA 
  r2[QA2==34841] <- NA 
  r2[QA2==34842] <- NA 
  r2[QA2==34843] <- NA 
  r2[QA2==34877] <- NA 
  r2[QA2==34878] <- NA 
  r2[QA2==34890] <- NA 
  r2[QA2==34894] <- NA 
  r2[QA2==34898] <- NA 
  r2[QA2==34942] <- NA 
  r2[QA2==34957] <- NA 
  r2[QA2==34958] <- NA 
  r2[QA2==34961] <- NA 
  r2[QA2==34962] <- NA 
  r2[QA2==34965] <- NA 
  r2[QA2==34966] <- NA 
  r2[QA2==35005] <- NA 
  r2[QA2==35006] <- NA 
  r2[QA2==35029] <- NA 
  r2[QA2==35030] <- NA 
  r2[QA2==35033] <- NA 
  r2[QA2==35034] <- NA 
  r2[QA2==35037] <- NA 
  r2[QA2==35038] <- NA 
  r2[QA2==35069] <- NA 
  r2[QA2==35070] <- NA 
  r2[QA2==35093] <- NA 
  r2[QA2==35094] <- NA 
  r2[QA2==35097] <- NA 
  r2[QA2==35098] <- NA 
  r2[QA2==35099] <- NA 
  r2[QA2==35101] <- NA 
  r2[QA2==35102] <- NA 
  r2[QA2==35103] <- NA 
  r2[QA2==35133] <- NA 
  r2[QA2==35134] <- NA 
  r2[QA2==35135] <- NA 
  r2[QA2==35150] <- NA 
  r2[QA2==35154] <- NA 
  r2[QA2==35158] <- NA 
  r2[QA2==35198] <- NA 
  r2[QA2==35217] <- NA 
  r2[QA2==35218] <- NA 
  r2[QA2==35221] <- NA 
  r2[QA2==35222] <- NA 
  r2[QA2==35225] <- NA 
  r2[QA2==35226] <- NA 
  r2[QA2==35261] <- NA 
  r2[QA2==35262] <- NA 
  r2[QA2==35289] <- NA 
  r2[QA2==35290] <- NA 
  r2[QA2==35293] <- NA 
  r2[QA2==35294] <- NA 
  r2[QA2==35297] <- NA 
  r2[QA2==35298] <- NA 
  r2[QA2==35325] <- NA 
  r2[QA2==35326] <- NA 
  r2[QA2==35870] <- NA 
  r2[QA2==35874] <- NA 
  r2[QA2==35878] <- NA 
  r2[QA2==35879] <- NA 
  r2[QA2==35902] <- NA 
  r2[QA2==35926] <- NA 
  r2[QA2==35930] <- NA 
  r2[QA2==35934] <- NA 
  r2[QA2==35966] <- NA 
  r2[QA2==35994] <- NA 
  r2[QA2==35998] <- NA 
  r2[QA2==36002] <- NA 
  r2[QA2==36030] <- NA 
  r2[QA2==36066] <- NA 
  r2[QA2==36070] <- NA 
  r2[QA2==36074] <- NA 
  r2[QA2==36094] <- NA 
  r2[QA2==36130] <- NA 
  r2[QA2==36134] <- NA 
  r2[QA2==36135] <- NA 
  r2[QA2==36138] <- NA 
  r2[QA2==36139] <- NA 
  r2[QA2==36158] <- NA 
  r2[QA2==36159] <- NA 
  r2[QA2==36186] <- NA 
  r2[QA2==36190] <- NA 
  r2[QA2==36194] <- NA 
  r2[QA2==36222] <- NA 
  r2[QA2==36254] <- NA 
  r2[QA2==36258] <- NA 
  r2[QA2==36262] <- NA 
  r2[QA2==36286] <- NA 
  r2[QA2==36326] <- NA 
  r2[QA2==36330] <- NA 
  r2[QA2==36334] <- NA 
  r2[QA2==36350] <- NA 
  r2[QA2==36881] <- NA 
  r2[QA2==36882] <- NA 
  r2[QA2==36885] <- NA 
  r2[QA2==36886] <- NA 
  r2[QA2==36889] <- NA 
  r2[QA2==36890] <- NA 
  r2[QA2==36925] <- NA 
  r2[QA2==36926] <- NA 
  r2[QA2==37005] <- NA 
  r2[QA2==37009] <- NA 
  r2[QA2==37013] <- NA 
  r2[QA2==37053] <- NA 
  r2[QA2==37077] <- NA 
  r2[QA2==37081] <- NA 
  r2[QA2==37085] <- NA 
  r2[QA2==37141] <- NA 
  r2[QA2==37142] <- NA 
  r2[QA2==37145] <- NA 
  r2[QA2==37146] <- NA 
  r2[QA2==37147] <- NA 
  r2[QA2==37149] <- NA 
  r2[QA2==37150] <- NA 
  r2[QA2==37181] <- NA 
  r2[QA2==37182] <- NA 
  r2[QA2==37918] <- NA 
  r2[QA2==37922] <- NA 
  r2[QA2==37926] <- NA 
  r2[QA2==37950] <- NA 
  r2[QA2==37974] <- NA 
  r2[QA2==37978] <- NA 
  r2[QA2==37982] <- NA 
  r2[QA2==38046] <- NA 
  r2[QA2==38050] <- NA 
  r2[QA2==38078] <- NA 
  r2[QA2==38118] <- NA 
  r2[QA2==38122] <- NA 
  r2[QA2==38178] <- NA 
  r2[QA2==38182] <- NA 
  r2[QA2==38186] <- NA 
  r2[QA2==38206] <- NA 
  r2[QA2==38933] <- NA 
  r2[QA2==38934] <- NA 
  r2[QA2==38937] <- NA 
  r2[QA2==39053] <- NA 
  r2[QA2==39057] <- NA 
  r2[QA2==39189] <- NA 
  r2[QA2==39193] <- NA 
  r2[QA2==39194] <- NA 
  r2[QA2==39197] <- NA 
  r2[QA2==39229] <- NA 
  r2[QA2==39230] <- NA 
  r2[QA2==40230] <- NA 
  r2[QA2==40234] <- NA 
  r2[QA2==40254] <- NA 
  r2[QA2==51221] <- NA 
  r2[QA2==51225] <- NA 
  r2[QA2==51229] <- NA 
  r2[QA2==51261] <- NA 
  r2[QA2==51353] <- NA 
  r2[QA2==51417] <- NA 
  r2[QA2==51421] <- NA 
  r2[QA2==51425] <- NA 
  r2[QA2==51481] <- NA 
  r2[QA2==51485] <- NA 
  r2[QA2==51486] <- NA 
  r2[QA2==51489] <- NA 
  r2[QA2==51491] <- NA 
  r2[QA2==51517] <- NA 
  r2[QA2==51519] <- NA 
  r2[QA2==51609] <- NA 
  r2[QA2==51613] <- NA 
  r2[QA2==51677] <- NA 
  r2[QA2==51681] <- NA 
  r2[QA2==51685] <- NA 
  r2[QA2==51709] <- NA 
  r2[QA2==52262] <- NA 
  r2[QA2==52266] <- NA 
  r2[QA2==52518] <- NA 
  r2[QA2==52522] <- NA 
  r2[QA2==52526] <- NA 
  r2[QA2==53269] <- NA 
  r2[QA2==53273] <- NA 
  r2[QA2==53277] <- NA 
  r2[QA2==53309] <- NA 
  r2[QA2==53529] <- NA 
  r2[QA2==53533] <- NA 
  r2[QA2==53537] <- NA 
  r2[QA2==53565] <- NA 
  r2[QA2==54566] <- NA 
  r2[QA2==55321] <- NA 
  r2[QA2==55581] <- NA 
  r2[QA2==55585] <- NA 
  r2[QA2==999999] <- NA 
  writeRaster(r2, filename = evi.out.name[i], format="GTiff", overwrite=T)
}


